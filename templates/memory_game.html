{% extends "base.html" %}

{% block content %}
<div class="container mx-auto text-center p-4">

    <div class="mb-8">
        <h1 class="text-5xl md:text-6xl font-bold text-primary">משחק הזיכרון  </h1>
        <p class="text-xl mt-2">מאחורי כל קלף מסתתר חצי מתמונה שלנו ביחד</p>
        <p class="text-xl mt-2">תנסי להתאים בין 2 חצאים של אותן התמונות (ותוכיחי לי שהזכרון שלך מצויין למרות ההייט)</p>

    </div>

    <div id="game-board" class="grid grid-cols-4 sm:grid-cols-8 gap-4 max-w-8xl mx-auto mb-8">
        {% for card in cards %}
        <div class="game-card aspect-square bg-base-300 rounded-lg shadow-lg cursor-pointer" data-image="{{ card.url }}">
            <div class="card-inner">
                
                <div class="card-front {{ card.side }}" 
                     style="background-image: url('{{ url_for('static', filename=card.url) }}');">
                </div>

                <div class="card-back bg-secondary rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-1/2 w-1/2 text-secondary-content" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <a href="{{ url_for('home') }}" class="btn btn-ghost">חזרה לדף הראשי</a>

    <div id="combined-image-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="relative max-w-[90vw] max-h-[90vh]">
            <img id="combined-image" src="" alt="Memory" class="rounded-lg shadow-lg object-contain max-h-[85vh]">
            <button id="close-overlay-button" class="absolute -top-4 -right-4 btn btn-sm btn-circle btn-error">✕</button>
        </div>
    </div>

    <div id="celebration" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center text-white p-8 hidden z-50">
        <h2 class="text-6xl md:text-8xl font-bold" style="font-family: var(--font-header);">כל הכבוד!</h2>
        <p class="text-2xl md:text-3xl mt-4">השלמת את כל התמונות שלנו ❤️</p>
        <button id="restart-button" class="btn btn-primary mt-8 btn-lg">שחקי שוב</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
    /* 3D Card Flip Logic */
    .game-card {
        perspective: 1000px;
    }
    .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        transform: rotateY(180deg);
    }
    .game-card.flipped .card-inner {
        transform: rotateY(0deg);
    }
    .card-front, .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 0.5rem;
        background-color: white; 
    }

    /* --- The Split Logic --- */
    .card-front {
        background-repeat: no-repeat;
        /* Zoom the image so it is double the width of the card.
           This allows us to show only half of it. */
        background-size: 200% 100%; 
    }

    /* If it's a LEFT card, align image to the left edge */
    .card-front.left {
        background-position: left center;
        border-right: 2px dashed rgba(0,0,0,0.1); /* Cute detail: dashed line where cut */
    }

    /* If it's a RIGHT card, align image to the right edge */
    .card-front.right {
        background-position: right center;
        border-left: 2px dashed rgba(0,0,0,0.1);
    }

    .card-back {
        transform: rotateY(180deg);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.game-card');
        const celebrationOverlay = document.getElementById('celebration');
        const restartButton = document.getElementById('restart-button');
        const combinedImageOverlay = document.getElementById('combined-image-overlay');
        const combinedImage = document.getElementById('combined-image');
        const closeOverlayButton = document.getElementById('close-overlay-button');

        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let matchesFound = 0;
        const totalPairs = cards.length / 2;

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            secondCard = this;
            lockBoard = true;

            checkForMatch();
        }

        function checkForMatch() {
            // Logic: Do the data-image URLs match? 
            // Since we have one Left and one Right for each URL, this is sufficient!
            let isMatch = firstCard.dataset.image === secondCard.dataset.image;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            matchesFound++;

            // Show full image overlay
            setTimeout(() => {
                // Parse the URL from the background-image style to show in full screen
                const style = firstCard.querySelector('.card-front').style.backgroundImage;
                // Clean up the url(...) wrapper to get just the path
                const url = style.slice(4, -1).replace(/"/g, "");
                showImageOverlay(url);
            }, 600);
        }

        function unflipCards() {
            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function showImageOverlay(url) {
            combinedImage.src = url;
            combinedImageOverlay.classList.remove('hidden');
            combinedImageOverlay.classList.add('flex');
        }

        closeOverlayButton.addEventListener('click', () => {
            combinedImageOverlay.classList.add('hidden');
            combinedImageOverlay.classList.remove('flex');
            
            if (matchesFound === totalPairs) {
                setTimeout(showCelebration, 500);
            }
            
            resetBoard();
        });

        function showCelebration() {
            celebrationOverlay.classList.remove('hidden');
            celebrationOverlay.classList.add('flex');
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } }));
            }, 250);
        }

        restartButton.addEventListener('click', () => {
            location.reload();
        });

        cards.forEach(card => card.addEventListener('click', flipCard));
    });
</script>
{% endblock %}