{% extends "base.html" %}

{% block content %}
<div class="container mx-auto text-center p-4">

    <div class="mb-8">
        <h1 class="text-5xl md:text-6xl font-bold text-primary">משחק הזיכרון  </h1>
        <p class="text-xl mt-2">מאחורי כל קלף מסתתר חצי מתמונה שלנו ביחד</p>
        <p class="text-xl mt-2">תנסי להתאים בין 2 חצאים של אותן התמונות (ותוכיחי לי שהזכרון שלך מצויין למרות ההייט)</p>
    </div>

    <div id="game-board" class="grid grid-cols-3 sm:grid-cols-4 gap-4 max-w-2xl mx-auto mb-8">
        {% for card in cards %}
        <div class="game-card aspect-square bg-base-300 rounded-lg shadow-lg cursor-pointer" data-image="{{ card.url }}">
            <div class="card-inner">
                
                <div class="card-front bg-white overflow-hidden relative">
                    <img src="{{ url_for('static', filename=card.url) }}" 
                         alt="Memory"
                         class="absolute top-0 h-full max-w-none object-cover"
                         style="width: 200%; {{ 'left: 0;' if card.side == 'left' else 'left: -100%;' }}">
                    
                    <div class="absolute inset-y-0 {{ 'right-0 border-r-2' if card.side == 'left' else 'left-0 border-l-2' }} border-dashed border-white/30 pointer-events-none"></div>
                </div>

                <div class="card-back bg-secondary rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-1/2 w-1/2 text-secondary-content" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <a href="{{ url_for('home') }}" class="btn btn-ghost">חזרה לדף הראשי</a>

    <div id="combined-image-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden z-50">
        <div class="relative max-w-[95vw] max-h-[95vh]">
            <img id="combined-image" src="" alt="Memory" class="rounded-lg shadow-2xl object-contain max-h-[85vh]">
            <button id="close-overlay-button" class="absolute -top-4 -right-4 btn btn-sm btn-circle btn-error">✕</button>
        </div>
    </div>

    <div id="celebration" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center text-white p-8 hidden z-50">
        <h2 class="text-6xl md:text-8xl font-bold" style="font-family: var(--font-header);">כל הכבוד!</h2>
        <p class="text-2xl md:text-3xl mt-4">השלמת את כל התמונות שלנו ❤️</p>
        <button id="restart-button" class="btn btn-primary mt-8 btn-lg">שחקי שוב</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
    /* 3D Card Flip Logic */
    .game-card {
        perspective: 1000px;
    }
    .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        transform: rotateY(180deg);
    }
    .game-card.flipped .card-inner {
        transform: rotateY(0deg);
    }
    .card-front, .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 0.5rem;
    }
    .card-back {
        transform: rotateY(180deg);
    }
    .card-front {
        /* No transform needed here as it's the "front" face (0deg relative to inner) */
        transform: rotateY(0deg); 
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.game-card');
        const celebrationOverlay = document.getElementById('celebration');
        const restartButton = document.getElementById('restart-button');
        const combinedImageOverlay = document.getElementById('combined-image-overlay');
        const combinedImage = document.getElementById('combined-image');
        const closeOverlayButton = document.getElementById('close-overlay-button');

        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let matchesFound = 0;
        const totalPairs = cards.length / 2;

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            secondCard = this;
            lockBoard = true;

            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.image === secondCard.dataset.image;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            matchesFound++;

            setTimeout(() => {
                // We grab the src from the <img> tag directly now
                const img = firstCard.querySelector('.card-front img');
                const url = img.getAttribute('src');
                showImageOverlay(url);
            }, 600);
        }

        function unflipCards() {
            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function showImageOverlay(url) {
            combinedImage.src = url;
            combinedImageOverlay.classList.remove('hidden');
            combinedImageOverlay.classList.add('flex');
        }

        closeOverlayButton.addEventListener('click', () => {
            combinedImageOverlay.classList.add('hidden');
            combinedImageOverlay.classList.remove('flex');
            
            if (matchesFound === totalPairs) {
                setTimeout(showCelebration, 500);
            }
            resetBoard();
        });

        function showCelebration() {
            celebrationOverlay.classList.remove('hidden');
            celebrationOverlay.classList.add('flex');
            var duration = 3 * 1000;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };
            
            confetti({ ...defaults, particleCount: 100, origin: { y: 0.6 } });
        }

        restartButton.addEventListener('click', () => {
            location.reload();
        });

        cards.forEach(card => card.addEventListener('click', flipCard));
    });
</script>
{% endblock %}